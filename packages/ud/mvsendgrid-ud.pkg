0078ABMVSENDGRID.BPþ0c0000C90MVSENDGRID.TESTþ0c2      * PROGRAM MVSENDGRID.TESTþ      *þþ      OPEN "MVDB.CONTROL" TO F.CONFIG ELSEþ         PRINT "No MVDB.CONTROL file"þ         STOPþ      ENDþ      READ MVSENDGRID.CONFIG FROM F.CONFIG, "MVSENDGRID.CONFIG.JSON" ELSEþ         PRINT "MVSendgrid is not configured yet.  Please run MVSENDGRID.CONFIG"þ         STOPþ      ENDþþ      PRINT "Enter email to send test to: ":; INPUT TEST.EMAIL.TOþ      PRINT "Enter full path to file to send (leave blank to not send a file): ":; INPUT FILE.TO.SENDþ      IF FILE.TO.SEND # "" THENþ         PRINT "Type of file: 1-pdf, 2=text: ":; INPUT ANSþ         BEGIN CASEþ            CASE ANS="1"; FILE.TYPE="application/pdf"þ            CASE ANS="2"; FILE.TYPE="text/plain"þ            CASE 1þ               PRINT "Invalid choice"þ               STOPþ         END CASEþ         PRINT "Actual file name (no path): ":; INPUT FILE.NAMEþ         IF FILE.NAME="" THEN STOPþ      ENDþ      WOBJ="WOBJ"þþ      OBJ="MAILSEND_V2"þ      CALL MVSENDGRID.API(OBJ)þ      *þþ      CALL @WOBJ(OBJ,"TOSTRING","",JSON,"PRETTIFY",1)þþþ      CALL @WOBJ(OBJ,"SET","params.to[0].email",TEST.EMAIL.TO,"",RERR)þ      CALL @WOBJ(OBJ,"SET","params.to[0].name","Test Email","",RERR)þþ      * SINCE CC IS A OPTION, THERE IS NOT A PRE-POPULATED OBJECT, WE MUST ADD ONEþ      CALL @WOBJ(OBJ,"SET.OBJECT","params.bcc[0]","{}","",RERR)þ      CALL @WOBJ(OBJ,"SET","params.bcc[0].email",TEST.EMAIL.TO,"",RERR)þ      CALL @WOBJ(OBJ,"SET","params.bcc[0].name","Test Email","",RERR)þþþ      CALL @WOBJ(OBJ,"SET","params.from","noreply@zumasys.com","",RERR)þþ      CALL @WOBJ(OBJ,"SET","params.subject","Sample email ":TIMEDATE(),"",RERR)þþ      NL=CHAR(13):CHAR(10)þþ      TEXT="Line 1"þ      TEXT:=NL:"Line 2"þ      TEXT:=NL:"Line 3"þþ      CALL @WOBJ(OBJ,"SET","params.text",TEXT,"",RERR)þþ      IF FILE.TO.SEND # "" THENþþ         CALL @WOBJ(OBJ,"SET.ARRAY","params.files","[]","",RERR)þþ         CALL @WOBJ(SOBJ,"FROMSTRING","","{}","",RERR)þ         CALL @WOBJ(SOBJ,"SET","sourcefile",FILE.TO.SEND,"",RERR)þ         CALL @WOBJ(SOBJ,"SET","filename",FILE.NAME,"",RERR)þ         CALL @WOBJ(SOBJ,"SET","type",FILE.TYPE,"",RERR)þ         CALL @WOBJ(SOBJ,"TOSTRING","",SJSON,"",RERR)þ         CALL @WOBJ(OBJ,"SET.OBJECT","params.files[-1]",SJSON,"",RERR)þþ      ENDþþ      CALL @WOBJ(OBJ,"TOSTRING","",JSON,"PRETTIFY",RERR)þ      PRINT "Press return to see the jSON option payload before calling MVSENDGRID.API":; INPUT WAITþ      PRINT JSONþ      PRINTþ      PRINT "Press return to call MVSENDGRID.  If you request a file that does not exist the routine does not catch that and your call will fail. ":; INPUT ANSþþ      CALL MVSENDGRID.API(OBJ)þþ      CALL @WOBJ(OBJ,"GET","result.status",STATUSCODE,"",RERR)þ      PRINT "Result status=":STATUSCODEþ      CALL @WOBJ(OBJ,"GET","result.statusmsg",STATUSMSG,"",RERR)þ      PRINT "Result msg   =":STATUSMSGþþ      IF STATUSCODE = "ok" OR STATUSCODE[1,1] = "2" THEN NULL ELSEþ         PRINT "Failed: ":STATUSMSGþ      ENDþþ      CALL @WOBJ(OBJ,"GET","result.wcalldebug",COBJ.JSON,"",RERR)þ      CALL @WOBJ(COBJ,"FROMSTRING","",COBJ.JSON,"",RERR)þþ      CALL MVDBTOOLKIT.WCALL.DEBUG(COBJ)þþ      PRINT "PRESS RETURN TO CONTINUE: ":; INPUT OK.TO.CONTINUEþ004197MVSENDGRID.APIþ0c2      SUBROUTINE MVSENDGRID.API(OBJ)þ      **********************************************************************þ      *þ      * Copyright (C) 2018 Zumasys, Inc., All Rights Reservedþ      *þ      * Written by: Patrick Payne, Zumasysþ      * Date: 4/2/2019þ      * Description: SENDGRID wrapperþþ      **********************************************************************þ      *þ      * Purpose of this program is to front end the sendgrid library of functionsþ      *þ      * Change Logþ      *þ      * 1/24/2021 -pap   Added Loggingþ      *þ      * Descriptionþ      *þ      * It will utilize the object model concept and try to wrap all sendgridþ      * functions into this one libraryþ      *þ      * Items to doþ      *þ      * Add File option. (COMPLETED)þ      * qc tests to validate fields sent (OUTSTANDING)þ      * Config to get user name/password/etc (COMPLETED)þ      * Return Message/Status (COMPLETED)þ      * REMOVE ALL DEBUG STATEMENTS (COMPLETED)þ      *þ      * OBJþ      * { "api":"mailsend_v2",þ      *    "params": {þ      *       "to": [þ      *         {þ      *           "email":"email address",þ      *           "name":"Nice name"þ      *         }þ      *       ],þ      *       "cc": [þ      *         {þ      *           "email":"email address",þ      *           "name":"Nice name"þ      *         }þ      *       ],þ      *       "bcc": [þ      *         {þ      *           "email":"email address",þ      *           "name":"Nice name"þ      *         }þ      *       ],þ      *       "debug":"Y or N",þ      *       "replyto":"address",þ      *       "from":"From email address",þ      *       "fromname":"From name",þ      *       "subject":"Subject",þ      *       "text":"Plain text of your email",þ      *       "html":"Html version of your email",þ      *       "files": [þ      *           {þ      *              "sourcefile":"path to file",þ      *              "filename":"file name to present file as",þ      *              "type":"type of file, application/pdf for example"þ      *           }þ      *       ]þ      *    },þ      *   "result": {þ      *      "status":"error or ok",þ      *      "statusmsg:"status msg"þ      *    }þ      *þ      *  }þ      *þ      * Starting with mailsend_v2 - We are using this version because it allowsþ      * attachments without having to base64 and include them into the json payloadþ      * v2 uses curl and a normal form-data post to get attachments.þ      *þ      * curl https://api.sendgrid.com/api/mail.send.json \þ      *-F to=recipient@domain.com -F toname=test -F subject="Example Subject" \þ      *-F text="testing text body" --form-string html="<strong>testing html body</strong>" \þ      *-F from=test@yourdomain.com -F api_user=your_sendgrid_username -F api_key=your_sendgrid_password \þ      *-F files\[attachment.gz\]=@f.php.gzþ      *þ      *þ      * This intial part will initialize a object for a user.þ      *þþ      WOBJ="WOBJ"þþ      FIELD.TYPE=""þþ      INIT.FUNCTION=OCONV(OBJ<1,1,1>,"MCU")þþ      BEGIN CASEþ         CASE INIT.FUNCTION="MAILSEND_V2"þ            GOSUB mailsendv2.initþ            RETURNþ      END CASEþþ      CALL WOBJ(OBJ,"GET","api",API,"",RERR)þ      CALL WOBJ(OBJ,"GET","debug",DO.DEBUG,"",RERR)þ      IF OCONV(DO.DEBUG[1,1],"MCU") = "Y" OR DO.DEBUG="1" THEN DO.DEBUG=1 ELSE DO.DEBUG=0þþ      CALL WOBJ(OBJ,"SET.OBJECT","result","{}","",RERR)þþ      API=OCONV(API,'MCU')þþ      APISTATUS="ok"þ      APISTATUSMSG=""þþ      OPEN "MVDB.CONTROL" TO F.MVDB.CONTROL ELSEþ         APISTATUS='error'þ         APISTATUSMSG='Could not open MVDB.CONTROL'þ         GOTO end.of.routineþ      ENDþþ      SUBJECT=''; FROMEMAIL=''; WHO.TO1=''þ      þ      *þ      * 7/21/202 PAP - Added option to pull config from MDþ      *                Changed nameþþ      READ CONFIG FROM F.MVDB.CONTROL,"MVSENDGRID.CONFIG.JSON"  ELSEþ         APISTATUS="error"þ         APISTATUSMSG="NO MVSENDGRID.CONFIG IN MVDB.CONTROL."þ         GOTO end.of.routineþ      ENDþþ      IF TRIM(CONFIG) = "" THENþ         APISTATUS="error"þ         APISTATUSMGS="No config record."þ         GOTO end.of.routineþ      ENDþþ      CALL MVDBTOOLKIT.WPLATFORM(PLATFORMOBJ)þ      þ      CALL WOBJ(PLATFORMOBJ,"GET","filedelim",PLATFORM.FILE.DELIMITER,"",RERR)þ      þ      þ      CALL WOBJ(CONFIGOBJ,"FROMSTRING","",CONFIG,"",RERR)þþ      * 1/23/2021 pap - Added option to turn on debugging from config fileþþ      CALL WOBJ(CONFIGOBJ,"GET","debug",CONFIG.DEBUG,"",RERR)þþ      IF OCONV(CONFIG.DEBUG[1,1],'MCU') = 'Y' THEN DO.DEBUG=1þ      þ      * 1/24/2021 - Added loggingþ      þ      CALL WOBJ(CONFIGOBJ,"GET","mvlogging",MVLOGGING,"",RERR)þ      þ      IF MVLOGGING THENþ          OPEN "MVSENDGRID.LOG" TO F.MVSENDGRID.LOG ELSE MVLOGGING=0þ          IF MVLOGGING THENþ              OPEN "DICT","MVSENDGRID.LOG" TO F.DICT.MVSENDGRID.LOG ELSE MVLOGGING=0þ          ENDþ      ENDþþ      BEGIN CASEþ         CASE API="MAILSEND_V2"þ            GOSUB mailsendv2þ         CASE 1þ            APISTATUS="error"þ            APISTATUSMSG="Invalid api request (":API:")"þ      END CASEþþ      * lets do a larger check for a failed callþþ      CALL WOBJ(COBJ,"GET","response.status",STATUSCODE,"",RERR)þ      CALL WOBJ(COBJ,"GET","response.statusmsg",STATUSMSG,"",RERR)þ      IF STATUSCODE[1,1] # "2" THENþ         APISTATUS=STATUSCODEþ         APISTATUSMSG=STATUSMSGþ      ENDþþ      * LETS PACKAGE THE ENTIRE CURL RESPONSE FOR DEBUGGING PURPOSES.þ      CALL WOBJ(COBJ,"TOSTRING","",COBJ.JSON,"",RERR); * SAFER TO PULL JSONþ      CALL WOBJ(OBJ,"SET","result.wcalldebug",COBJ.JSON,"",RERR)þþþend.of.routine: *þþ      CALL WOBJ(OBJ,"SET","result.status",APISTATUS,"",RERR)þ      CALL WOBJ(OBJ,"SET","result.statusmsg",APISTATUSMSG,"",RERR)þ      CALL WOBJ(OBJ,"SET","result.response",RESPONSE,"",RERR)þ  þ      IF MVLOGGING THENþ          READU NEXT.MVLOGGING.ID FROM F.DICT.MVSENDGRID.LOG, "NEXT.ID" ELSE NEXT.MVLOGGING.ID=1þ          NEXT.MVLOGGING.ID+=1þ          IF NEXT.MVLOGGING.ID >= MVLOGGING THEN NEXT.MVLOGGING.ID=1þ          WRITE NEXT.MVLOGGING.ID ON F.DICT.MVSENDGRID.LOG, "NEXT.ID"þ          MVLOGGING.REC=DATE()þ          MVLOGGING.REC<2>=TIME()þ          CALL MVDBTOOLKIT.USER.INFO(USER.INFO,"MV")þ          MVLOGGING.REC<3>=USER.INFO<1>þ          MVLOGGING.REC<4>=USER.INFO<3>þ          MVLOGGING.REC<5>=USER.INFO<6>þ          MVLOGGING.REC<6>=APISTATUSþ          MVLOGGING.REC<7>=APISTATUSMSGþ          CONVERT @AM TO @VM IN RESPONSEþ          MVLOGGING.REC<8>=RESPONSEþ          MVLOGGING.REC<9>=FROMEMAILþ          MVLOGGING.REC<10>=WHO.TO1þ          MVLOGGING.REC<11>=SUBJECTþ          WRITE MVLOGGING.REC ON F.MVSENDGRID.LOG, NEXT.MVLOGGING.IDþ      ENDþ      þ      RETURNþ      STOPþþmailsendv2.init: * Initialize a email v2 objectþþ      OBJ=""þ      CALL WOBJ(OBJ,"FROMSTRING","","{}","",RERR)þ      CALL WOBJ(OBJ,"SET","api","mailsend_v2","",RERR)þ      CALL WOBJ(OBJ,"SET.OBJECT","params","{}","",RERR)þ      CALL WOBJ(OBJ,"SET.ARRAY","params.to",'[{"email":"","name"}]',"",RERR)þ      CALL WOBJ(OBJ,"SET.ARRAY","params.cc",'[]',"",RERR)þ      CALL WOBJ(OBJ,"SET.ARRAY","params.bcc",'[]',"",RERR)þ      CALL WOBJ(OBJ,"SET.ARRAY","params.files",'[]',"",RERR)þþ      RETURNþþþmailsendv2: * Send an emailþþ      * V2 USES USER NAME AND PASSWORDþ      CALL WOBJ(CONFIGOBJ,"GET","username",SENDGRID.USERNAME,"",RERR)þ      CALL WOBJ(CONFIGOBJ,"GET","password",SENDGRID.PASSWORD,"",RERR)þþ      IF SENDGRID.USERNAME="" THENþ         APISTATUS="error"þ         APISTATUSMSG="No username defined in CONFIG.JSON"þ         RETURNþ      ENDþ      IF SENDGRID.PASSWORD="" THENþ         APISTATUS="error"þ         AISTATUSMSG="No password defined in CONFIG.JSON"þ         RETURNþ      ENDþþ      CALL WOBJ(OBJ,"LENGTH","params.to",NUMBER.TOO,"",RERR)þ      IF NOT(NUMBER.TOO) THENþ         APISTATUS="error"þ         APISTATUS="Must supply array of to"þ         RETURNþ      ENDþþ      TOO.LABEL="to"; TOO.NAMES.LABEL="toname"þ      IF NUMBER.TOO > 1 THEN TOO.LABEL:='[]'; TOO.NAMES.LABEL:='[]'þþ      TOO=''; TOO.NAMES=''þþ      CALL WOBJ(COBJ,"FROMSTRING","","{}","",RERR)þ      CALL WOBJ(COBJ,"SET","method","POST","",RERR)þ      CALL WOBJ(COBJ,"SET","url","https://api.sendgrid.com/api/mail.send.json","",RERR)þ      CALL WOBJ(COBJ,"SET","insecure","Y","",RERR)þþ      CALL WOBJ(COBJ,"SET.OBJECT","headers","{}","",RERR)þ      CALL WOBJ(COBJ,"SET","headers.Authorization","Bearer ":SENDGRID.PASSWORD,"",RERR)þþþ      CALL WOBJ(COBJ,"SET.ARRAY","formfields","[]","",RERR)þþ      FIELD.NAME="api_user"; FIELD.VALUE=SENDGRID.USERNAME; GOSUB set.fieldþ      FIELD.NAME="api_key"; FIELD.VALUE=SENDGRID.PASSWORD; GOSUB set.fieldþþ      FOR X=1 TO NUMBER.TOOþ         P="params.to[":X-1:"]"þ         CALL WOBJ(OBJ,"GET",P:".email",THIS.TO,"",RERR)þ         CALL WOBJ(OBJ,"GET",P:".name",THIS.NAME,"",RERR)þ         IF X=1 THEN WHO.TO1=THIS.TOþ         IF INDEX(THIS.TO,'@',1) THENþ            TOO<-1>=THIS.TOþ            TOO.NAMES<-1>=THIS.NAMEþ            FIELD.NAME=TOO.LABELþ            FIELD.VALUE=THIS.TOþ            GOSUB set.fieldþ            FIELD.NAME=TOO.NAMES.LABELþ            FIELD.VALUE=THIS.NAMEþ            GOSUB set.fieldþþ         ENDþ      NEXT Xþþ      *CONVERT CHAR(254) TO ',' IN TOOþ      *CONVERT CHAR(254) TO ',' IN TOO.NAMESþ      *þ      *CALL WOBJ(SOBJ,"FROMSTRING","","{}","",RERR)þ      *CALL WOBJ(SOBJ,"SET","name",TOO.LABEL,"",RERR)þ      *CALL WOBJ(SOBJ,"SET","value",TOO,"",RERR)þ      *CALL WOBJ(SOBJ,"TOSTRING","",SJSON,"",RERR)þ      *CALL WOBJ(COBJ,"SET.OBJECT","formfields[-1]",SJSON,"",RERR)þ      *þ      *FIELD.NAME=TOO.NAMES.LABEL; FIELD.VALUE=TOO.NAMES; GOSUB set.fieldþþ      * DO CCþþ      CALL WOBJ(OBJ,"LENGTH","params.cc",NUMBER.CC,"",RERR)þ      CC.LABEL="cc"; CC.NAMES.LABEL="ccname"þ      IF NUMBER.CC > 1 THEN CC.LABEL:='[]'; CC.NAMES.LABEL:='[]'þþ      FOR X=1 TO NUMBER.CCþ         P="params.cc[":X-1:"]"þ         CALL WOBJ(OBJ,"GET",P:".email",THIS.CC,"",RERR)þ         CALL WOBJ(OBJ,"GET",P:".name",THIS.NAME,"",RERR)þ         IF INDEX(THIS.CC,'@',1) THENþ            FIELD.NAME=CC.LABELþ            FIELD.VALUE=THIS.CCþ            GOSUB set.fieldþ            FIELD.NAME=CC.NAMES.LABELþ            FIELD.VALUE=THIS.NAMEþ            GOSUB set.fieldþ         ENDþþ      NEXT Xþþ      *CONVERT CHAR(254) TO ',' IN CCþ      *CONVERT CHAR(254) TO ',' IN CC.NAMESþ      *þ      *CC.LABEL="cc"; CC.NAMES.LABEL="ccname"þ      *IF NUMBER.CC > 1 THEN CC.LABEL:='[]'; CC.NAMES.LABEL:='[]'þ      *FIELD.NAME=CC.LABEL; FIELD.VALUE=CC; GOSUB set.fieldþ      *FIELD.NAME=CC.NAMES.LABEL; VALUE=CC.NAMES; GOSUB set.fieldþþ      *ENDþþ      * DO BCCþþ      CALL WOBJ(OBJ,"LENGTH","params.bcc",NUMBER.BCC,"",RERR)þ      BCC.LABEL="bcc"; BCC.NAMES.LABEL="bccname"þ      IF NUMBER.BCC > 1 THEN BCC.LABEL:='[]'; BCC.NAMES.LABEL:='[]'þþ      IF NUMBER.BCC THENþþ         BCC=''; BCC.NAMES=''þ         FOR X=1 TO NUMBER.BCCþ            P="params.bcc[":X-1:"]"þ            CALL WOBJ(OBJ,"GET",P:".email",THIS.BCC,"",RERR)þ            CALL WOBJ(OBJ,"GET",P:".name",THIS.NAME,"",RERR)þ            IF INDEX(THIS.BCC,'@',1) THENþ               BCC<-1>=THIS.BCCþ               BCC.NAMES<-1>=THIS.NAMEþ               FIELD.NAME=BCC.LABELþ               FIELD.VALUE=THIS.TOþ               GOSUB set.fieldþ               FIELD.NAME=BCC.NAMES.LABELþ               FIELD.VALUE=THIS.NAMEþ               GOSUB set.fieldþ            ENDþþ         NEXT Xþþ         *CONVERT CHAR(254) TO ',' IN BCCþ         *CONVERT CHAR(254) TO ',' IN BCC.NAMESþ         *þ         *BCC.LABEL="bcc"; BCC.NAMES.LABEL="bccname"þ         *IF NUMBER.BCC > 1 THEN BCC.LABEL:='[]'; BCC.NAMES.LABEL:='[]'þ         *FIELD.NAME=BCC.LABEL; FIELD.VALUE=BCC; GOSUB set.fieldþ         *FIELD.NAME=BCC.NAMES.LABEL; VALUE=BCC.NAMES; GOSUB set.fieldþþ      ENDþþþ      CALL WOBJ(OBJ,"GET","params.from",FROMEMAIL,"",RERR)þ      IF FROMEMAIL="" THENþ         APISTATUS="error"þ         APISTATUSMSG="Must supply from"þ         RETURNþ      ENDþ      FIELD.NAME="from"; FIELD.VALUE=FROMEMAIL; GOSUB set.fieldþþ      ** GET BODY **þþ      CALL WOBJ(OBJ,"GET","params.text",TEXT.BODY,"",RERR)þ      CALL WOBJ(OBJ,"GET","params.html",HTML.BODY,"",RERR)þ      IF HTML.BODY="" AND TEXT.BODY="" THENþ         APISTATUS="error"þ         APISTATUSMSG="Must supply either a text or html message"þ         RETURNþ      ENDþþ      * If our text.body has new lines in it we MUST write it outþ      * to a file and then pass it as a file handle!!!þ      *þþ      *IF INDEX(TEXT.BODY,CHAR(13),1) OR INDEX(TEXT.BODY,CHAR(10),1) THENþ      * 4/2/2020 - This fix is moving to wcallþþ      IF 0 THENþ         CALL WOBJ(FOBJ,"FROMSTRING","","{}","",RERR)þ         CALL WOBJ(FOBJ,"SET","action","WRITE","",RERR)þ         TMP.DIR="/tmp"; * This needs to be fixed to be dynamicþ         USER.NO=FIELD(OCONV('','U50BB'),' ',1)þ         TEXT.FILE.NAME=TMP.DIR:'/':USER.NO:"_body.txt"þ         CALL WOBJ(FOBJ,"SET","path",TEXT.FILE.NAME,"",RERR)þ         CALL WOBJ(FOBJ,"SET","data",TEXT.BODY,"",RERR)þ         CALL MVDBTOOLKIT.WFILEIO(FOBJ)þ         FIELD.NAME="text"; FIELD.VALUE="@":TEXT.FILE.NAME; FIELD.TYPE="file"; GOSUB set.fieldþ      END ELSEþ         FIELD.NAME="text"; FIELD.VALUE=TEXT.BODY; GOSUB set.fieldþ      ENDþþ      * NEED TO ADD THE HTMLþþ      IF HTML.BODY = "" AND TEXT.BODY # "" THENþ         * WE NEED TO BUILD OUT A SIMPLE HTML VERSION, BASICALLY DOING NEW LINESþ         HAS.CR=DCOUNT(TEXT.BODY,CHAR(13))þ         HAS.LF=DCOUNT(TEXT.BODY,CHAR(10))þ         HTML.BODY=TEXT.BODYþ         BEGIN CASEþ            CASE HAS.CR AND HAS.LF AND HAS.CR=HAS.LFþ               CONVERT CHAR(10) TO '' IN HTML.BODYþ               CONVERT CHAR(13) TO @AM IN HTML.BODYþ            CASE HAS.LFþ               CONVERT CHAR(10) TO @AM IN HTML.BODYþ               CONVERT CHAR(13) TO '' IN HTML.BODYþ            CASE HAS.CRþ               CONVERT CHAR(13) TO @AM IN HTML.BODYþ               CONVERT CHAR(10) TO '' IN HTML.BODYþ         END CASEþ         NUM.LINES=DCOUNT(HTML.BODY,@AM)þ         NEW.HTML.BODY=""þ         FOR A=1 TO NUM.LINESþ            LINE=HTML.BODY<A>þ            IF A > 1 THEN NEW.HTML.BODY:='<BR>'þ            NEW.HTML.BODY:=LINEþ         NEXT Aþ         HTML.BODY=NEW.HTML.BODYþ      ENDþþ      IF HTML.BODY # "" THENþ         *HTML.BODY="HTML VERSION<BR>":HTML.BODYþ         FIELD.NAME="html"; FIELD.VALUE=HTML.BODY; GOSUB set.fieldþ      ENDþþ      ** SUBJECT **þþ      CALL WOBJ(OBJ,"GET","params.subject",SUBJECT,"",RERR)þ      IF SUBJECT="" THENþ         APISTATUS="error"þ         APISTATUSMSG="Must supply subject"þ         RETURNþ      ENDþ      FIELD.NAME="subject"; FIELD.VALUE=SUBJECT; GOSUB set.fieldþþþ      ** file uploads **þþ      CALL WOBJ(OBJ,"LENGTH","params.files",NUM.FILES,"",RERR)þþ      IF NUM.FILES THENþ         FOR X=1 TO NUM.FILESþ            P="params.files[":X-1:"]"þ            CALL WOBJ(OBJ,"GET",P:'.sourcefile',SOURCEFILE,"",RERR)þ            CALL WOBJ(OBJ,"GET",P:'.filename',FILENAME,"",RERR)þ            CALL WOBJ(OBJ,"GET",P:'.type',FILETYPE,"",RERR)þ     þ            IF FILENAME = "" THENþ                XX=DCOUNT(SOURCEFILE,PLATFORM.FILE.DELIMITER)þ                FILENAME=FIELD(SOURCEFILE,PLATFORM.FILE.DELIMITER,XX)þ            ENDþ            þ            IF FILETYPE = '' THENþ               FILE.DOTS=DCOUNT(FILENAME,'.')þ               FILE.EXT=FIELD(FILENAME,'.',FILE.DOTS)þ               FILE.EXT=OCONV(FILE.EXT,'MCU')þ               BEGIN CASEþ                  CASE FILE.EXT='PDF'; FILETYPE='application/pdf'þ               END CASEþ            ENDþ            þ            FIELD.NAME='files[':FILENAME:']'þ            FIELD.VALUE='@':SOURCEFILEþ            IF FILETYPE # "" THEN FIELD.VALUE:=";type=":FILETYPEþ            FIELD.TYPE='file'þ            GOSUB set.fieldþ         NEXT Xþ      ENDþþþ      CALL WOBJ(COBJ,"TOSTRING","",CJSON,"PRETTIFY",RERR)þþ      IF DO.DEBUG THENþ         CALL WOBJ(COBJ,"SET","debug","Y","",RERR); * SET TO DO DEBUGGINGþ      ENDþþ      CALL MVDBTOOLKIT.WCALL(COBJ)þþþ      CALL WOBJ(COBJ,"TOSTRING","",TJSON,"PRETTIFY",RERR)þþ      CALL WOBJ(COBJ,"GET","response.data",RESPONSE,"",RERR)þþ      CALL WOBJ(ROBJ,"FROMSTRING","",RESPONSE,"",RERR)þ      CALL WOBJ(ROBJ,"GET","message",APISTATUSMSG,"",RERR)þ      CALL WOBJ(COBJ,"GET","response.status",STATUS.MSG,"",RERR)þþ      RETURNþþþset.field: *þþ      CALL WOBJ(SOBJ,"FROMSTRING","","{}","",RERR)þ      CALL WOBJ(SOBJ,"SET","name",FIELD.NAME,"",RERR)þ      CALL WOBJ(SOBJ,"SET","value",FIELD.VALUE,"",RERR)þ      IF FIELD.TYPE # "" THENþ         CALL WOBJ(SOBJ,"SET","fieldtype",FIELD.TYPE,"",RERR)þ      ENDþ      FIELD.TYPE=""þ      CALL WOBJ(SOBJ,"TOSTRING","",SJSON,"",RERR)þ      CALL WOBJ(COBJ,"SET.OBJECT","formfields[-1]",SJSON,"",RERR)þ      CALL WOBJ(COBJ,"TOSTRING","",TESTJSON,"PRETTIFY",RERR)þ      *      PRINT TESTJSONþ      *INPUT WAITþ      RETURN000C89MVSENDGRID.CONFIGþ0c2      * Configure sendgridþþ      OPEN "MVDB.CONTROL" TO F.CONFIG ELSEþ         PRINT "No MVDB.CONTROL file."þ         STOPþ      ENDþþ      * READ CONFIGURATION RECORD.  THIS FUNCTION WILL BE DEFAULT WANT THISþ      * TO BE IN THE MD/VOCþþ      READ MVSENDGRID.CONFIG FROM F.CONFIG, "MVSENDGRID.CONFIG.JSON" ELSE MVSENDGRID.CONFIG="{}"þþ      CALL WOBJ(OBJ,"FROMSTRING","",MVSENDGRID.CONFIG,"",RERR)þ      IF RERR # "" THENþ         PRINT RERR<2>þ         STOPþ      ENDþþuser.name: *þ      PRINT @(-1)þ      CALL WOBJ(OBJ,"GET","username",USER.NAME,"",RERR)þ      PRINTþ      PRINT "User Name: ":USER.NAMEþ      PRINT "Enter new user name or press return to keep current value or q to quit."þ      PRINTþ      PRINT "User Name: ":; INPUT NEW.USER.NAMEþþ      IF OCONV(NEW.USER.NAME,"MCU") = "Q" THEN STOPþ      þ      IF NEW.USER.NAME # "" THEN USER.NAME=NEW.USER.NAMEþþ      IF USER.NAME = "" THENþ         PRINTþ         PRINT "You must supply a user name.":; INPUT WAITþ         GOTO user.nameþ      ENDþ      þ      CALL WOBJ(OBJ,"SET","username",USER.NAME,"",RERR)þþpassword: *þ      PRINT @(-1)þ      CALL WOBJ(OBJ,"GET","password",PASSWORD,"",RERR)þ      PRINTþ      PRINT "Password: ":PASSWORDþ      PRINT "Enter Password or press return to keep current value or q to quit."þ      PRINTþ      PRINT "Password: ":; INPUT NEW.PASSWORDþ      þ      IF OCONV(NEW.PASSWORD,"MCU") = "Q" THEN STOPþþ      IF NEW.PASSWORD # "" THEN PASSWORD = NEW.PASSWORDþ      þ      IF PASSWORD = "" THENþ         PRINTþ         PRINT "You must supply a password.":; INPUT WAITþ         GOTO passwordþ      ENDþþ      CALL WOBJ(OBJ,"SET","password",PASSWORD,"",RERR)þþdomain: *þ      PRINT @(-1)þ      CALL WOBJ(OBJ,"GET","domain",DOMAIN,"",RERR)þ      PRINTþ      PRINT "Default Doman: ":DOMAINþ      PRINT "Enter Default Domain or press return to keep current value or q to quit."þ      PRINTþ      PRINT "Default Domain: ":; INPUT NEW.ANSWERþ      þ      IF OCONV(NEW.ANSWER,"MCU") = "Q" THEN STOPþþ      IF NEW.ANSWER # "" THEN DOMAIN = NEW.ANSWERþ      þ      IF DOMAIN = "" THENþ         PRINTþ         PRINT "You must supply a DOMAIN.":; INPUT WAITþ         GOTO domainþ      ENDþþ      CALL WOBJ(OBJ,"SET","domain",DOMAIN,"",RERR)þþmvlogging: *þ      PRINT @(-1)þ      CALL WOBJ(OBJ,"GET","mvlogging",CURRENT.ANSWER,"",RERR)þ      PRINTþ      PRINT "MVLogging Lines: ":CURRENT.ANSWERþ      PRINT "Enter number of lines to log in MVSENDGRID.LOG or press return to keep current value or q to quit."þ      PRINTþ      PRINT "MVLogging (0 for none): ":; INPUT NEW.ANSWERþ      þ      IF OCONV(NEW.ANSWER,"MCU") = "Q" THEN STOPþþ      IF NEW.ANSWER # "" THEN CURRENT.ANSWER = NEW.ANSWERþ      þ      IF CURRENT.ANSWER = "" THENþ         PRINTþ         PRINT "You must supply a answer.":; INPUT WAITþ         GOTO mvloggingþ      ENDþþ      CALL WOBJ(OBJ,"SET","mvlogging",CURRENT.ANSWER,"",RERR)       þend.of.routine: *þþ      CALL WOBJ(OBJ,"TOSTRING","",JSON,"PRETTIFY",RERR)þ      CONVERT CHAR(10) TO '' IN JSONþ      CONVERT CHAR(13) TO @AM IN JSONþ      þ      WRITE JSON ON F.CONFIG, "MVSENDGRID.CONFIG.JSON"þ      PRINT "Updated MVDB.CONTROL MVSENDGRID.CONFIG.JSON"þ      þ      STOPþ      00167CMVSENDGRID.SIMPLE.EMAILþ0c2      SUBROUTINE MVSENDGRID.SIMPLE.EMAIL(WHO.TO.PARAM,WHO.FROM.PARAM,WHO.CC.PARAM,WHO.BCC.PARAM,SUBJECT,BODY,ATTACHMENTS.PARAM,OPTIONS,RESULT)þþ      **********************************************************************þ      *þ      * Copyright (C) 2018 Zumasys, Inc., All Rights Reservedþ      *þ      * Written by: Patrick Payne, Zumasysþ      * Date: 1/23/2021þ      * Description: Simple MV based email routineþþ      **********************************************************************þ      *þ      * This function allows you to use pick Dynamic variables to defineþ      * your params vs using WOBJ.þ      *þ      * WHO.TO.PARAM:              Comma list of email addresses to send to.þ      *                            Attribute 2 is optional nameþ      * WHO.FROM.PARAM:            Who fromþ      * WHO.CC.PARAM               Comma list of email addresses to CCþ      * WHO.BCC.PARAMþ      * SUBJECT                    Subjectþ      * Body                       Test Body.  If you want html use full functionþ      *                            Put in @HTML@ as line 1 if you want htmlþ      * ATTACHMENTS.PARAM          comma list of files to sendþ      *                            Attr2: Comma list of actual file name - Default Att1þ      *                            Attr3: Comma list of file type - Default TXTþ      * OPTIONS                    1 = DEFAULT DOMAINþ      *þ      * RESULT                     1 = Result, 0=error, 1=okþ      *                            2 = Error messageþþ      RESULT=1þþ      OPEN "MVDB.CONTROL" TO F.CONFIG ELSEþ         PRINT "No MVDB.CONTROL file."þ         RESULT=0þ         RESULT<2>="No MVDB.CONTROL file."þ         RETURNþ      ENDþþ      * READ CONFIGURATION RECORD.  THIS FUNCTION WILL BE DEFAULT WANT THISþ      * TO BE IN THE MD/VOCþþ      READ MVSENDGRID.CONFIG FROM F.CONFIG, "MVSENDGRID.CONFIG.JSON" ELSEþ         RESULT=0þ         RESULT<2>='MVSendgrid not configed'þ         RETURNþ      ENDþþ      CALL WOBJ(OBJ,"FROMSTRING","",MVSENDGRID.CONFIG,"",RERR)þþ      IF RERR # "" THENþ         PRINT RERR<2>þ         RESULT=0þ         RESULT<2>=RERR<2>þ      ENDþþ      CALL WOBJ(OBJ,"GET","domain",DEFAULT.DOMAIN,"",RERR)þþ      IF OPTIONS<1> # "" THEN DEFAULT.DOMAIN=OPTIONS<1>þþ      OBJ="MAILSEND_V2"þ      CALL MVSENDGRID.API(OBJ)þ      *þþ      CALL WOBJ(OBJ,"TOSTRING","",JSON,"PRETTIFY",1)þþ      PARAMS=WHO.TO.PARAMþ      TYPE.PARAM='params.to';   GOSUB ADD.WHOTOSþ      *þ      IF WHO.CC.PARAM <> '' THENþ         CALL WOBJ(OBJ,"SET.OBJECT","params.cc[0]","{}","",RERR)þ         PARAMS=WHO.CC.PARAMþ         TYPE.PARAM='params.cc'þ         GOSUB ADD.WHOTOSþ      ENDþþ      IF WHO.BCC.PARAM <> '' THENþ         CALL WOBJ(OBJ,"SET.OBJECT","params.bcc[0]","{}","",RERR)þ         PARAMS=WHO.BCC.PARAMþ         TYPE.PARAM='params.bcc'; GOSUB ADD.WHOTOSþ      ENDþþ      PARAM=WHO.FROM.PARAM; GOSUB ADD.DOMAINþ      CALL WOBJ(OBJ,"SET","params.from",PARAM.WITH.COMPANY,"",RERR)þþ      CALL WOBJ(OBJ,"SET","params.subject",SUBJECT,"",RERR)þþ      OBJ.BODY=BODYþ      CONVERT @AM:@VM:CHAR(252) TO CHAR(13):CHAR(13):CHAR(13) IN OBJ.BODYþ      CONVERT CHAR(13) TO CHAR(10) IN OBJ.BODYþþ      CALL WOBJ(OBJ,"SET","params.text",OBJ.BODY,"",RERR)þþ      CALL WOBJ(OBJ,"SET","debug","Y","",RERR)þþ      CALL WOBJ(OBJ,"SET.ARRAY","params.files","[]","",RERR)þþ      CALL WOBJ(SOBJ,"FROMSTRING","","{}","",RERR)þþ      ATTACHMENTS=ATTACHMENTS.PARAMþþ      CONVERT ',' TO @VM IN ATTACHMENTSþ      MAX.ATTACHMENTS=DCOUNT(ATTACHMENTS<1>,@VM)þ      IF NOT(MAX.ATTACHMENTS) THEN MAX.ATTACHMENTS=1þþ      FOR ATTACH.CNTR = 1 TO MAX.ATTACHMENTSþþ         ATTACHMENT=ATTACHMENTS<1,ATTACH.CNTR>þ         ATTACHMENT.FILENAME=ATTACHMENTS<2,ATTACH.CNTR>þ         ATTACHMENT.TYPE=ATTACHMENTS<3,ATTACH.CNTR>þþ         CALL WOBJ(SOBJ,"SET","sourcefile",ATTACHMENT,"",RERR)þ         IF ATTACHMENT.FILENAME # "" THENþ            CALL WOBJ(SOBJ,"SET","filename",ATTACHMENT.FILENAME,"",RERR)þ         ENDþ         IF ATTACHMENT.TYPE # "" THENþ            CALL WOBJ(SOBJ,"SET","type",ATTACHMENT.TYPE,"",RERR)þ         ENDþ         CALL WOBJ(SOBJ,"TOSTRING","",SJSON,"",RERR)þ         CALL WOBJ(OBJ,"SET.OBJECT","params.files[-1]",SJSON,"",RERR)þ      NEXT ATTACH.CNTRþþ      CALL WOBJ(OBJ,"TOSTRING","",JSON,"PRETTIFY",RERR)þþ      CALL MVSENDGRID.API(OBJ)þþ      CALL WOBJ(OBJ,"GET","result.status",STATUS,"",RERR)þ      CALL WOBJ(OBJ,"GET","result.statusmsg",STATUS.MSG,"",RERR)þ      CALL WOBJ(OBJ,"GET","result.response",MAIL.RESPONSE,"",RERR)þþ      IF STATUS[1,1] # "2" THENþ         RESULT=0þ         RESULT<2>=STATUS.MSGþ         RESULT<3>=STATUSþ         RESULT<4>=MAIL.RESPONSEþ      END ELSEþ         RESULT<2>=MAIL.RESPONSEþ      ENDþþþ      *CALL WOBJ(OBJ,"TOSTRING","",JSON,"PRETTIFY",RERR)þþ      RETURNþþ      *þADD.WHOTOS:þ      *þ      CONVERT ',' TO @VM IN PARAMSþ      MAX.PARAMS=DCOUNT(PARAMS<1>,@VM)þþ      FOR PARAM.CNTR = 1 TO MAX.PARAMSþþ         PARAM=PARAMS<1,PARAM.CNTR>þ         PARAM2=PARAMS<2,PARAM.CNTR>þþ         GOSUB ADD.DOMAINþþ         * WE NEED TO ADD OUR OBJECT TO THE ARRAYþ         CALL WOBJ(OBJ,"LENGTH",TYPE.PARAM,NUM.ELEMENTS,"",RERR)þþ         IF NUM.ELEMENTS < PARAM.CNTR THENþ            CALL WOBJ(OBJ,"SET.OBJECT",TYPE.PARAM:"[-1]","{}","",RERR)þ         ENDþþ         PARAM.INDEX=TYPE.PARAM:'[':PARAM.CNTR-1:']'þþ         CALL WOBJ(OBJ,"SET",PARAM.INDEX:".email",PARAM.WITH.COMPANY,"",RERR)þþ         IF TRIM(PARAM2) # "" THENþ            CALL WOBJ(OBJ,"SET",PARAM.INDEX:".name",PARAM2,"",RERR)þ         ENDþ      NEXT PARAM.CNTRþ      RETURNþþ      *þþADD.DOMAIN:þ      *þ      IF INDEX(PARAM,'@',1) THENþ         PARAM.WITH.COMPANY=PARAMþ         RETURNþ      ENDþ      PARAM.WITH.COMPANY=PARAM:'@':DEFAULT.DOMAINþ      RETURNþþ      ENDþþ000750MVSENDGRID.SET.DEBUGGINGþ0c2      **********************************************************************þ      *þ      * Copyright (C) 2018 Zumasys, Inc., All Rights Reservedþ      *þ      * Written by: Patrick Payne, Zumasysþ      * Date: 1/23/2021þ      * Description: Set debugging via the config fileþþ      **********************************************************************þ      *þ      * The purpose of this program is to set the flag on/off in the configþ      * file that will make wcall and mvsendgrid leave all the configþ      * files written to make the call.  This allows you to re-runþ      * items from a command line. þ      þþ      OPEN "MVDB.CONTROL" TO F.CONFIG ELSEþ         PRINT "No MVDB.CONTROL file."þ         STOPþ      ENDþþ      * READ CONFIGURATION RECORD.  THIS FUNCTION WILL BE DEFAULT WANT THISþ      * TO BE IN THE MD/VOCþþ      READ MVSENDGRID.CONFIG FROM F.CONFIG, "MVSENDGRID.CONFIG.JSON" ELSE þ         PRINT "MVSendgrid not configured.  Run MVSENDGRID.CONFIG."þ         STOPþ      ENDþ      þ      CALL WOBJ(OBJ,"FROMSTRING","",MVSENDGRID.CONFIG,"",RERR)þ      IF RERR # "" THENþ         PRINT RERR<2>þ         STOPþ      ENDþþdebug: *þ      PRINT @(-1)þ      CALL WOBJ(OBJ,"GET","debug",CONFIG.DEBUG,"",RERR)þ      PRINTþ      PRINT "DEBUG?: ":CONFIG.DEBUGþ      PRINTþ      PRINT "Choose new value: (Y or N): ":; INPUT NEW.CONFIG.DEBUGþþ      NEW.CONFIG.DEBUG=OCONV(NEW.CONFIG.DEBUG[1,1],'MCU')þ      þ      IF OCONV(NEW.CONFIG.DEBUG,"MCU") = "Q" OR NEW.CONFIG.DEBUG='' THEN STOPþ          þ      CALL WOBJ(OBJ,"SET","debug",NEW.CONFIG.DEBUG,"",RERR)þþ      CALL WOBJ(OBJ,"TOSTRING","",JSON,"PRETTIFY",RERR)þþ      CONVERT CHAR(10) TO @AM IN JSONþ      CONVERT CHAR(13) TO '' IN JSONþ      þ      WRITE JSON ON F.CONFIG, "MVSENDGRID.CONFIG.JSON"þ      PRINT "Updated MVDB.CONTROL MVSENDGRID.CONFIG.JSON"þ      þ      STOPþ      000148MV.INSTALL.CFþ0c0000057MVAPPS-PRE-SCRIPTþ0c0CREATE-FILE DIR MVSENDGRID.BPþCREATE-FILE MVSENDGRID.LOG 1,1 501,1000086MVAPPS-POST-SCRIPTþ0c0SELECT MVSENDGRID.BP NE "_]"ýBASIC MVSENDGRID.BPþSELECT MVSENDGRID.BP NE "_]"ýCATALOG MVSENDGRID.BP FORCE DIRECT000048PACKAGE.INFOþ0c0SendGrid Email Integration APIþ2.0.7þdbþþþMVSENDGRIDþ2120001CBDICT_MVSENDGRID.LOGþ0c0000018DATEþ0c1Aþ1þþþþþD0-þþRþ5000018TIMEþ0c1Aþ2þþþþþMTSþþRþ8000016USERþ0c1Aþ3þþþþþþþLþ10000015PORTþ0c1Aþ5þþþþþþþRþ4000017STATUSþ0c1Aþ6þþþþþþþLþ500001BSTATUSMSGþ0c1Aþ7þþþþþþþTþ1000001ARESPONSEþ0c1Aþ8þþþþþþþTþ1500001AACCOUNTþ0c1Aþ5þþþ4þþþþLþ12000016FROMþ0c1Aþ9þþþþþþþTþ15000015TOþ0c1Aþ10þþþþþþþLþ1500001ASUBJECTþ0c1Aþ11þþþþþþþTþ100000301þ0c1MþID-SUPP DATE TIME FROM TO SUBJECT STATUS 000030@þ0c1PHþID-SUPP DATE TIME FROM TO SUBJECT STATUS000068MVDB.CONTROLþ0c0000052MVSENDGRID.PACKAGE.JSONþ0c2{þ "bpfiles": [þ   { "filename": "MVSENDGRID.BP" }þ ]þ}